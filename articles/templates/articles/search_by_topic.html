{% extends "articles/base_public.html" %}

{% load static %}

{% block styles %}
    <link rel="stylesheet" type="text/css" href="{% static 'articles/style.css' %}">
{% endblock %}

{% block topics_active %}class="active"{% endblock %}

{% block content %}

<div class="jumbotron">
    <h1 id="topic_description">{{ topic }}</h1>
</div>


<div class="container">
    <!-- |  DRAFTS  |  PUBLISHED  |  NEW_DRAFT  | -->
    <div>
        <div>
            <ul class="nav nav-tabs nav-justified">
                {% for key, value in topics %}
                    <li {% if topic_key == key %} class="active" {% endif %}>
                        <a data-toggle="pill" href="#{{ key }}" onclick="loadArticles('{{ key }}', '{{ value }}')">{{ value }}</a>
                    </li>
                {% endfor %}
                <!--<li class="active"><a data-toggle="pill" href="#draft_articles" onclick="loadArticles(this, drafts = false, published = true)">Artifical Intelligence </a></li>
                <li><a data-toggle="pill" href="#published_articles" onclick="loadArticles(this, drafts = true, published = false)">Web Programming </a></li>
                <li><a data-toggle="pill">Software Engineering</a></li>
                <li><a data-toggle="pill">Data Science</a></li>
                <li><a data-toggle="pill">Cryptography</a></li>-->
                
                <script>

                    function read_article_url(id){
                        return '/articles/' + id + '/';
                    }

                    function topic_articles_url(topic){
                        return '/topic/' + topic + '/';
                    }
                    
                    function getCookie(name) {
                        var cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            var cookies = document.cookie.split(';');
                            for (var i = 0; i < cookies.length; i++) {
                                var cookie = jQuery.trim(cookies[i]);
                                // Does this cookie string begin with the name we want?
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }






                    var active_topic = '{{ topic_key }}';

                    var active_page = [];
                    active_page["AI"] = 1;
                    active_page["WP"] = 1;
                    active_page["SE"] = 1;
                    active_page["DS"] = 1;
                    active_page["C"] = 1;

                    var already_loaded = [];
                    already_loaded["AI"] = false;
                    already_loaded["WP"] = false;
                    already_loaded["SE"] = false;
                    already_loaded["DS"] = false;
                    already_loaded["C"] = false;

                    already_loaded["{{ topic_key }}"] = true;



                    function loadArticles(topic_id, topic_description){

                        // Set the window location
                        history.pushState(null, topic_id + '_articles', '/topic/' + topic_id + '/');

                        // Set main heading (1st time) or active page
                        if (topic_description != null) 
                            document.getElementById("topic_description").innerHTML = topic_description;

                        // In case the action is legit (and not a random click)
                        if (active_topic != topic_id || already_loaded[topic_id]){

                            active_topic = topic_id;

                            if (topic_description != null && already_loaded[topic_id] == true) return;
                            else already_loaded[topic_id] = true;

                            // Set main heading (1st time) or active page
                            if (topic_description == null) 
                                active_page[topic_id] = active_page[topic_id] + 1;

                            // Load the articles
                            url = '/topic/' + topic_id + '/json/' + active_page[topic_id] + '/';
                            $.get(url, function(data, status){
                                

                                // Hide the loader circle
                                if (document.getElementById(topic_id + "_loader") != null)
                                    document.getElementById(topic_id + "_loader").style.display = 'none';
                                
                                // Process data
                                if (data.articles!=null){
                                    var user = data.author;
                                    var html = '';
                                    data.articles.forEach(article => {
                                        user_image_html = '<span class="glyphicon glyphicon-user pull-left"></span>';
                                        var article_image_url = (article.image_path != "" ? ('/static/articles/' + article.image_path) : "https://www.freeiconspng.com/uploads/no-image-icon-6.png")
                                        html += `
                                            <div class="col-md-6" id="article_box_${ article.id }">
                                                <div class="article-box">
                                                    <div class="row">
                                                        <div class="col-sm-6">
                                                            <div class="article-box-image" style="background-image: url('${article_image_url}');">
                                                                <div class="article-box-controls-container">
                                                                    <p class="article-box-controls">
                                                                        <a href="${ read_article_url(article.id) }"><span class="glyphicon glyphicon-eye-open edit-action-icon" title="Read"></span></a>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-sm-6" onclick="window.location.href = '${ read_article_url(article.id) }'">
                                                            <div class="article-box-content">
                                                                <div class="article-box-title">
                                                                    <h3>${ article.title }</h3>
                                                                    <p class="ellipsed">${ article.description }</p>
                                                                </div>
                                                                <div class="article-author">
                                                                    ${user_image_html}
                                                                    <h4><a href="/profile/@${ article.author }/">${ article.author }</a></h4>
                                                                    <p>
                                                                        <span class="glyphicon glyphicon-calendar"></span>&nbsp;
                                                                        ${ article.last_modified_date.split('T')[0] }</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    document.getElementById(topic_id + '_content').innerHTML += html;
                                }
                            });
                        }
                    }
                </script>
                
            </ul>
        </div>    
    </div>


    <!-- ARTICLES -->
    <div class="tab-content">
        {% for key, value in topics %}
            <div id="{{ key }}" class="tab-pane fade in {% if topic_key == key %} active {% endif %}">
                <br><br>
                <div class="row" id="{{ key }}_content">
                    {% if topic_key == key %}
                        {% for article in articles %}
                            <div class="col-md-6" id="article_box_{{ article.id }}" onclick="window.location.href = '{% url "articles:read_article" article.id %}'">
                                <div class="article-box">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            {% if article.image_path != "" %}
                                            <div class="article-box-image" style="background-image: url('/static/articles/{{ article.image_path }}');">
                                            {% else %}
                                            <div class="article-box-image" style="background-image: url('https://www.freeiconspng.com/uploads/no-image-icon-6.png');">
                                            {% endif %}                                    
                                                <div class="article-box-controls-container">
                                                    <p class="article-box-controls">
                                                        <a href="{% url 'articles:read_article' article.id %}"><span class="glyphicon glyphicon-eye-open edit-action-icon" title="Read"></span></a>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <!--<div class="col-sm-6" onclick="window.location.href = '{% url "articles:edit_article" article.id %}'">-->
                                        <div class="col-sm-6">
                                            <div class="article-box-content">
                                                <div class="article-box-title">
                                                    <h3>{{ article.title }}</h3>
                                                    <p class="ellipsed">{{ article.description }}</p>
                                                </div>
                                                <div class="article-author">
                                                    <span class="glyphicon glyphicon-user pull-left"></span>
                                                    <h4><a href="/profile/@{{ article.author }}/">{{ article.author }}</a></h4>
                                                    <p><span class="glyphicon glyphicon-calendar"></span>&nbsp; {{ article.last_modified_date | date:"Y-m-d" }}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                    <div id="{{ key }}_loader" class="loader {% if topic_key == key %} invisible {% endif %}"></div>
                </div>
            </div>
        {% endfor %}
    </div>



    <script>
        window.onscroll = function(ev) {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                // you're at the bottom of the page
                loadArticles(active_topic, null);
            }
        };
    </script>


</div>




{% endblock %}